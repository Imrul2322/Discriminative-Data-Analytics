clear,clc,close all
[~,txtData]  = xlsread('Symptonnames.xlsx','A1:PF1');
[temp]  = readmatrix('2018_country_daily_2018_US_daily_symptoms_dataset.csv');
temp2018 = temp(:,8:end);% whole dataset, 1-365 rows for Us, then each 365 rows for 1 state
[temp]  = readmatrix('2019_country_daily_2019_US_daily_symptoms_dataset.csv');
temp2019 = temp(:,8:end);% whole dataset, 1-365 rows for Us, then each 365 rows for 1 state
[temp]  = readmatrix('2020_country_daily_2020_US_daily_symptoms_dataset.csv');
temp2020 = temp(:,8:end);% whole dataset, 1-365 rows for Us, then each 365 rows for 1 state

temp2018(isnan(temp2018))=0;
temp2019(isnan(temp2019))=0;
temp2020(isnan(temp2020))=0;

feature_set =[7,351,20,412,110, 93,142, 139, 169];
sympts = {'Ageusia', 'Shortness of breath', 'Anosmia','Vomiting','Diarrhea','Cough','Fever','Fatigue','Headache'};

X = temp2020(:, feature_set );
Y = temp2019(:, feature_set );
Z = temp2018(:, feature_set );
% remove the rows when Anosmia is 0
X=X(find(X(:,1)~=0),:);
Y=Y(find(Y(:,1)~=0),:);
Z=Z(find(Z(:,1)~=0),:);

%% plot for slides
Ite = 1000;
ind = 1 : 9;
sympts_sorted = sympts(ind);
x = categorical(sympts_sorted);
x = reordercats(x,sympts_sorted);

%% alternatives
%cpca
alpha=0.1;
clear temp;
for ite = 1 : Ite
    Us = cpca_alpha(X, Y, alpha,1);
    temp(ite, :) = (Us(:,1))';
end
y = mean(temp);
figure;
subplot(3,2,1);
bar(x,y); grid on; title('cPCA (target:2020, background:2019) \alpha=0.1');
ylabel('Symptom coefficients');
y_std = std(temp);
hold on;    
errorbar(x,y,y_std,'k','LineStyle','none');


alpha=0.1;
clear temp;
for ite = 1 : Ite
    Us = cpca_alpha(X, Z, alpha,1);
    temp(ite, :) = (Us(:,1))';
end
y = mean(temp);
subplot(3,2,2);
bar(x,y); grid on; title('cPCA (target:2020, background:2018) \alpha=0.1');
ylabel('Symptom coefficients');
y_std = std(temp);
hold on;    
errorbar(x,y,y_std,'k','LineStyle','none');


alpha=0.5;
clear temp;
for ite = 1 : Ite
    Us = cpca_alpha(X, Y, alpha,1);
    temp(ite, :) = (Us(:,1))';
end
y = mean(temp);
subplot(3,2,3);
bar(x,y); grid on; title('cPCA (target:2020, background:2019) \alpha=0.5');
ylabel('Symptom coefficients');
y_std = std(temp);
hold on;    
errorbar(x,y,y_std,'k','LineStyle','none');

alpha=0.5;
clear temp;
for ite = 1 : Ite
    Us = cpca_alpha(X, Z, alpha,1);
    temp(ite, :) = (Us(:,1))';
end
y = mean(temp);
subplot(3,2,4);
bar(x,y); grid on; title('cPCA (target:2020, background:2018) \alpha=0.5');
ylabel('Symptom coefficients');
y_std = std(temp);
hold on;    
errorbar(x,y,y_std,'k','LineStyle','none');

alpha=0.9;
clear temp;
for ite = 1 : Ite
    Us = cpca_alpha(X, Y, alpha,1);
    temp(ite, :) = (Us(:,1))';
end
y = mean(temp);
subplot(3,2,5);
bar(x,y); grid on; title('cPCA (target:2020, background:2019) \alpha=0.9');
ylabel('Symptom coefficients');
y_std = std(temp);
hold on;    
errorbar(x,y,y_std,'k','LineStyle','none');

alpha=0.9;
clear temp;
for ite = 1 : Ite
    Us = cpca_alpha(X, Z, alpha,1);
    temp(ite, :) = (Us(:,1))';
end
y = mean(temp);
subplot(3,2,6);
bar(x,y); grid on; title('cPCA (target:2020, background:2018) \alpha=0.9');
ylabel('Symptom coefficients');
y_std = std(temp);
hold on;    
errorbar(x,y,y_std,'k','LineStyle','none');

% nnmf on 2020 data
k=1;
clear temp;
for ite = 1 : Ite
    [U,W] = nnmf(X' , k);
    s = zeros(k,1);
    for i = 1:size(U,2)
        s(i) = norm(U(:,i))* norm(W(i,:));
        U(:,i) = U(:,i)/norm(U(:,i));
    end
    [~, ind0] = sort(s, 'descend');
    Vrr = U(:, ind0(1:k));
    temp(ite, :) = (Vrr(:,1))';
end
y = mean(temp);
figure;
subplot(3,2,1);
bar(x,y); grid on; title('NNMF using 2020 data');
ylabel('Symptom coefficients');
y_std = std(temp);
hold on;    
errorbar(x,y,y_std,'k','LineStyle','none');

% nnmf on 2019 data
k=1;
clear temp;
for ite = 1 : Ite
    [U,W] = nnmf(Y' , k);
    s = zeros(k,1);
    for i = 1:size(U,2)
        s(i) = norm(U(:,i))* norm(W(i,:));
        U(:,i) = U(:,i)/norm(U(:,i));
    end
    [~, ind0] = sort(s, 'descend');
    Vrr = U(:, ind0(1:k));
    temp(ite, :) = (Vrr(:,1))';
end
y = mean(temp);
subplot(3,2,3);
bar(x,y); grid on; title('NNMF using 2019 data');
ylabel('Symptom coefficients');
y_std = std(temp);
hold on;    
errorbar(x,y,y_std,'k','LineStyle','none');

% nnmf on 2018 data
k=1;
clear temp;
for ite = 1 : Ite
    [U,W] = nnmf(Z' , k);
    s = zeros(k,1);
    for i = 1:size(U,2)
        s(i) = norm(U(:,i))* norm(W(i,:));
        U(:,i) = U(:,i)/norm(U(:,i));
    end
    [~, ind0] = sort(s, 'descend');
    Vrr = U(:, ind0(1:k));
    temp(ite, :) = (Vrr(:,1))';
end
y = mean(temp);
subplot(3,2,5);
bar(x,y); grid on; title('NNMF using 2018 data');
ylabel('Symptom coefficients');
y_std = std(temp);
hold on;    
errorbar(x,y,y_std,'k','LineStyle','none');

% pca on 2020 data
alpha=0;
clear temp;
for ite = 1 : Ite
    Us = cpca_alpha(X, Y, alpha,1);
    temp(ite, :) = (Us(:,1))';
end
y = mean(temp);
subplot(3,2,2);
y_std = std(temp);
x1 = x(1:3);
x2 = x(4:end);
y1 = y(1:3);
y2 = y(4:end);
y_std1 = y_std(1:3);
y_std2 = y_std(4:end);
bar(x1,y1,'FaceColor',[0 0.8 0]); grid on; title('PCA using 2020 data');
ylabel('Symptom coefficients');
hold on;    
errorbar(x1,y1,y_std1,'b','LineStyle','none');
hold on;
bar(x2,y2,'FaceColor',[0.8 0 0]); grid on; 
ylabel('Symptom coefficients');
hold on;    
errorbar(x2,y2,y_std2,'b','LineStyle','none');

% pca on 2019 data
alpha=0;
clear temp;
for ite = 1 : Ite
    Us = cpca_alpha(Y, X, alpha,1);
    temp(ite, :) = (Us(:,1))';
end
y = mean(temp);
subplot(3,2,4);
y_std = std(temp);
x1 = x(1:3);
x2 = x(4:end);
y1 = y(1:3);
y2 = y(4:end);
y_std1 = y_std(1:3);
y_std2 = y_std(4:end);
bar(x1,y1,'FaceColor',[0 0.8 0]); grid on; title('PCA using 2019 data');
ylabel('Symptom coefficients');
hold on;    
errorbar(x1,y1,y_std1,'b','LineStyle','none');
hold on;
bar(x2,y2,'FaceColor',[0.8 0 0]); grid on; 
ylabel('Symptom coefficients');
hold on;    
errorbar(x2,y2,y_std2,'b','LineStyle','none');

% pca on 2018 data
alpha=0;
clear temp;
for ite = 1 : Ite
    Us = cpca_alpha(Z, Y, alpha,1);
    temp(ite, :) = (Us(:,1))';
end
y = mean(temp);
subplot(3,2,6);
y_std = std(temp);
x1 = x(1:3);
x2 = x(4:end);
y1 = y(1:3);
y2 = y(4:end);
y_std1 = y_std(1:3);
y_std2 = y_std(4:end);
bar(x1,y1,'FaceColor',[0 0.8 0]); grid on; title('PCA using 2018 data');
ylabel('Symptom coefficients');
hold on;    
errorbar(x1,y1,y_std1,'b','LineStyle','none');
hold on;
bar(x2,y2,'FaceColor',[0.8 0 0]); grid on; 
ylabel('Symptom coefficients');
hold on;    
errorbar(x2,y2,y_std2,'b','LineStyle','none');

%% dpca
clear temp;
for ite = 1 : Ite
    [Vrr, Xr]=nndpca(X,Y,1);
    temp(ite, :) = (Vrr(:,1))';
end
y = mean(temp);
figure;
subplot(3,2,1);
y_std = std(temp);
x1 = x(1:3);
x2 = x(4:end);
y1 = y(1:3);
y2 = y(4:end);
y_std1 = y_std(1:3);
y_std2 = y_std(4:end);
bar(x1,y1,'FaceColor',[0 0.8 0]); grid on; title('DNA (target:2020, background:2019)');
ylabel('Symptom coefficients');
hold on;    
errorbar(x1,y1,y_std1,'b','LineStyle','none');
hold on;
bar(x2,y2,'FaceColor',[0.8 0 0]); grid on; 
ylabel('Symptom coefficients');
hold on;    
errorbar(x2,y2,y_std2,'b','LineStyle','none');

clear temp;
for ite = 1 : Ite
    [Vrr, Xr]=nndpca(X,Z,1);
    temp(ite, :) = (Vrr(:,1))';
end
y = mean(temp);
subplot(3,2,2);
y_std = std(temp);
x1 = x(1:3);
x2 = x(4:end);
y1 = y(1:3);
y2 = y(4:end);
y_std1 = y_std(1:3);
y_std2 = y_std(4:end);
bar(x1,y1,'FaceColor',[0 0.8 0]); grid on; title('DNA (target:2020, background:2018)');
ylabel('Symptom coefficients');
hold on;    
errorbar(x1,y1,y_std1,'b','LineStyle','none');
hold on;
bar(x2,y2,'FaceColor',[0.8 0 0]); grid on; 
ylabel('Symptom coefficients');
hold on;    
errorbar(x2,y2,y_std2,'b','LineStyle','none');

clear temp;
for ite = 1 : Ite
    [Vrr, Xr]=nndpca(Y,X,1);
    temp(ite, :) = (Vrr(:,1))';
end
y = mean(temp);
subplot(3,2,3);
y_std = std(temp);
x1 = x(1:3);
x2 = x(4:end);
y1 = y(1:3);
y2 = y(4:end);
y_std1 = y_std(1:3);
y_std2 = y_std(4:end);
bar(x1,y1,'FaceColor',[0 0.8 0]); grid on; title('DNA (target:2019, background:2020)');
ylabel('Symptom coefficients');
hold on;    
errorbar(x1,y1,y_std1,'b','LineStyle','none');
hold on;
bar(x2,y2,'FaceColor',[0.8 0 0]); grid on; 
ylabel('Symptom coefficients');
hold on;    
errorbar(x2,y2,y_std2,'b','LineStyle','none');


clear temp;
for ite = 1 : Ite
    [Vrr, Xr]=nndpca(Z,X,1);
    temp(ite, :) = (Vrr(:,1))';
end
y = mean(temp);
subplot(3,2,4);
y_std = std(temp);
x1 = x(1:3);
x2 = x(4:end);
y1 = y(1:3);
y2 = y(4:end);
y_std1 = y_std(1:3);
y_std2 = y_std(4:end);
bar(x1,y1,'FaceColor',[0 0.8 0]); grid on; title('DNA (target:2018, background:2020)');
ylabel('Symptom coefficients');
hold on;    
errorbar(x1,y1,y_std1,'b','LineStyle','none');
hold on;
bar(x2,y2,'FaceColor',[0.8 0 0]); grid on; 
ylabel('Symptom coefficients');
hold on;    
errorbar(x2,y2,y_std2,'b','LineStyle','none');

clear temp;
for ite = 1 : Ite
    [Vrr, Xr]=nndpca(Y,Z,1);
    temp(ite, :) = (Vrr(:,1))';
end
y = mean(temp);
subplot(3,2,5);
y_std = std(temp);
x1 = x(1:3);
x2 = x(4:end);
y1 = y(1:3);
y2 = y(4:end);
y_std1 = y_std(1:3);
y_std2 = y_std(4:end);
bar(x1,y1,'FaceColor',[0 0.8 0]); grid on; title('DNA (target:2019, background:2018)');
ylabel('Symptom coefficients');
hold on;    
errorbar(x1,y1,y_std1,'b','LineStyle','none');
hold on;
bar(x2,y2,'FaceColor',[0.8 0 0]); grid on; 
ylabel('Symptom coefficients');
hold on;    
errorbar(x2,y2,y_std2,'b','LineStyle','none');

clear temp;
for ite = 1 : Ite
    [Vrr, Xr]=nndpca(Z,Y,1);
    temp(ite, :) = (Vrr(:,1))';
end
y = mean(temp);
subplot(3,2,6);
y_std = std(temp);
x1 = x(1:3);
x2 = x(4:end);
y1 = y(1:3);
y2 = y(4:end);
y_std1 = y_std(1:3);
y_std2 = y_std(4:end);
bar(x1,y1,'FaceColor',[0 0.8 0]); grid on; title('DNA (target:2018, background:2019)');
ylabel('Symptom coefficients');
hold on;    
errorbar(x1,y1,y_std1,'b','LineStyle','none');
hold on;
bar(x2,y2,'FaceColor',[0.8 0 0]); grid on; 
ylabel('Symptom coefficients');
hold on;    
errorbar(x2,y2,y_std2,'b','LineStyle','none');






